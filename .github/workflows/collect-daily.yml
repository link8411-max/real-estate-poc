name: Daily Collection

on:
  schedule:
    # 하루 3회 (KST 기준)
    - cron: '0 22 * * *'   # KST 07:00 (UTC 22:00 전날)
    - cron: '0 4 * * *'    # KST 13:00
    - cron: '0 10 * * *'   # KST 19:00
  workflow_dispatch:  # 수동 실행 가능

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Download database from R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          python r2_utils.py download || echo "No existing DB found, starting fresh"

      - name: Show DB info before collection
        run: |
          if [ -f real_estate.db ]; then
            echo "DB exists: $(du -h real_estate.db)"
          else
            echo "No DB file found"
          fi

      - name: Run daily collection
        env:
          MOLIT_API_KEY: ${{ secrets.MOLIT_API_KEY }}
          DB_PATH: real_estate.db
          API_URL: ${{ secrets.API_URL }}
        run: |
          python collect_daily.py

      - name: Show DB info after collection
        run: |
          if [ -f real_estate.db ]; then
            echo "DB size: $(du -h real_estate.db)"
          fi

      - name: Upload database to R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          python r2_utils.py upload

      - name: Summary
        run: |
          echo "### Daily Collection Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **Months collected**: Current + Previous" >> $GITHUB_STEP_SUMMARY
          if [ -f real_estate.db ]; then
            echo "- **DB Size**: $(du -h real_estate.db | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi
